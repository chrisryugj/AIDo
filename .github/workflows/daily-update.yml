name: Daily Newsletter Generation

on:
  # ë§¤ì¼ ì˜¤ì „ 8ì‹œ (KST = UTC+9, ì¦‰ UTC 23ì‹œ)
  schedule:
    - cron: '0 23 * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥ (Actions íƒ­ì—ì„œ ë²„íŠ¼ í´ë¦­)
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Git push ê¶Œí•œ

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“‹ Show date info
        run: |
          echo "ðŸ• UTC Time: $(date -u)"
          echo "ðŸ‡°ðŸ‡· KST Time: $(TZ='Asia/Seoul' date)"

      - name: ðŸš€ Generate content
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ðŸ“ Starting content generation..."
          node auto-generate.js

      - name: ðŸ“Š Check if index.html changed
        id: check_changes
        run: |
          if git diff --quiet index.html; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
          fi

      - name: ðŸ’¾ Commit and push
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --global user.name "AI-Do Bot"
          git config --global user.email "action@github.com"

          # ë‚ ì§œ ì •ë³´
          DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d')

          git add index.html
          git commit -m "Update daily content for ${DATE}"
          git push

      - name: âœ… Done
        run: echo "ðŸŽ‰ Daily newsletter generation complete!"
